# Tonic Google Apps Script Project

This directory contains the complete Google Apps Script (GAS) project for Tonic database migrations and utilities.

> **Note:** This is a development-only tooling package. The version number in `package.json` is set to `0.0.0-dev` and does not track the main application version. This package is never published and is used solely for deploying migration scripts to Google Apps Script.

## ğŸš€ Quick Start

### Prerequisites
- Node.js and npm installed
- clasp CLI installed globally: `npm install -g @google/clasp`
- Authentication: `clasp login` (if not already logged in)
- Environment variable `GOOGLE_APPS_SCRIPT_ID` set in parent directory's `.env` file

### Initial Setup

1. Install clasp CLI globally:
```bash
npm install -g @google/clasp
```

2. Authenticate with Google:
```bash
clasp login
```

3. Set environment variable in `../.env`:
```bash
GOOGLE_APPS_SCRIPT_ID=your-google-apps-script-project-id
```

4. Generate `.clasp.json` and deploy:
```bash
cd gas/
npm run setup    # Generates .clasp.json from template
clasp push       # Deploy to GAS
```

### Development Workflow

1. **Make changes** to files in `src/` directory
2. **Deploy updates** with `clasp push`
3. **Test migrations** in the Google Apps Script editor
4. **Run functions** directly in the GAS environment

### Opening the Project

```bash
cd gas/
clasp open    # Opens GAS editor in browser
```

## ğŸ“ Project Structure

```
gas/
â”œâ”€â”€ .clasp.json                 # Clasp configuration (rootDir: src)
â”œâ”€â”€ .claspignore                # Ignore archived migrations
â”œâ”€â”€ package.json                # npm config
â”œâ”€â”€ setup.sh                    # Setup script
â”œâ”€â”€ generate-clasp-config.cjs   # Generates .clasp.json
â””â”€â”€ src/                        # GAS source (pushed to GAS)
    â”œâ”€â”€ Code.js                 # Main entry point with menus & utilities
    â”œâ”€â”€ appsscript.json         # GAS project manifest
    â””â”€â”€ mig/                    # Migration scripts
        â”œâ”€â”€ active/             # Active migrations (run/apply pattern)
        â”œâ”€â”€ dev/                # Development migrations
        â”œâ”€â”€ recurring/          # Recurring operations
        â”œâ”€â”€ archive/            # Archived (ignored by clasp)
        â”œâ”€â”€ Config.js           # Migration config
        â”œâ”€â”€ TEMPLATE_Migration.js
        â””â”€â”€ README.md
```

## ğŸ”§ Migration System

All active migrations follow the simple **run/apply** pattern:

### Pattern

1. **run()** - Creates `MIGRATION_*` working copies with changes
2. **apply()** - Deletes originals, renames working copies (DESTRUCTIVE)

### Usage

```javascript
// Step 1: Create working copies
runYourMigrationName();

// Step 2: Review MIGRATION_* sheets in Google Sheets

// Step 3: Make changes permanent (DESTRUCTIVE)
applyYourMigrationName();
```

### Active Migrations

- **REEN001**: Add intent columns to registrations
- **REEN002**: Create periods table
- **004**: Convert attendance tables to UUID
- **012**: Replace students/parents from incoming data

See `src/mig/active/` for all active migrations.

## ğŸ“ Creating New Migrations

1. Copy `src/mig/TEMPLATE_Migration.js`
2. Rename to `Migration_XXX_Description.js`
3. Update function names and class names
4. Define `sheetsToMigrate` array or working/final sheet names
5. Implement `_applyChangesToSheet()` or `_createNewTable()` methods
6. Deploy with `clasp push`
7. Test in GAS editor

## ğŸ”— Configuration

### `.clasp.json`

Generated by `npm run setup`. Contains:
- **scriptId**: Points to the Google Apps Script project
- **rootDir**: Set to `"src"` - only files in `src/` are pushed

### `appsscript.json`

- **timeZone**: Set to America/Los_Angeles
- **runtimeVersion**: Uses V8 for modern JavaScript features

### `Config.js`

Manages spreadsheet ID for migrations:
- Set `SPREADSHEET_ID` constant, or
- Store in Properties Service via `PropertiesService.getScriptProperties().setProperty('SPREADSHEET_ID', 'your-id')`

## âš ï¸ Important Notes

- **No backups**: Migrations don't create automatic backups - make manual backups before running
- **DESTRUCTIVE apply()**: The apply step deletes original tables and renames working copies
- **Safe to re-run**: Running the same migration multiple times is safe - it deletes previous working copies
- **Archive ignored**: Files in `mig/archive/` are not pushed to GAS

## ğŸ”— Related Documentation

- [Migration README](src/mig/README.md) - Detailed migration documentation
- [Google Apps Script Documentation](https://developers.google.com/apps-script)
- [Clasp CLI Documentation](https://github.com/google/clasp)
