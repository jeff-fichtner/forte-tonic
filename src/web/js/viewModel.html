<script>
    class ViewModel {

        async initializeAsync() {

            const authenticatedUser = await ApiClient.fetch(ServerFunctions.getAuthenticatedUser, x => new AuthenticatedUserResponse(x));

            const validations = [
                [authenticatedUser, 'No authenticated user received.', `Must authorize use of email address.`],
                [authenticatedUser.isOperator, 'Authenticated user is not an operator.', `You are not authorized.`]
            ];

            for (const [condition, errorMessage, alertMessage] of validations) {
                if (!condition) {
                    console.error(errorMessage);
                    alert(alertMessage);
                    await DomHelpers._waitForDocumentReadyAsync();
                    await this._setPageLoading(false, errorMessage);
                    return;
                }
            }

            console.log(`Authenticated user: ${JSON.stringify(authenticatedUser)}`);

            const [
                _,
                admins,
                instructors,
                students,
                registrations,
                classes,
                rooms
            ] =
                await Promise.all([
                    DomHelpers._waitForDocumentReadyAsync(),
                    ApiClient.fetch(ServerFunctions.getAdmins, x => x.map(y => new Admin(y))),
                    ApiClient.fetch(ServerFunctions.getInstructors, x => x.map(y => new Instructor(y))),
                    ApiClient.fetchAllPages(ServerFunctions.getStudents, x => new Student(x)),
                    ApiClient.fetchAllPages(ServerFunctions.getRegistrations, x => new Registration(x)),
                    ApiClient.fetch(ServerFunctions.getClasses, x => x.map(y => new Class(y))),
                    ApiClient.fetch(ServerFunctions.getRooms, x => x.map(y => new Room(y)))
                ]);

            M.AutoInit();

            this.currentUser = authenticatedUser;

            this._initContent(admins, instructors, students, registrations, classes, rooms);

            this.navTabs = new NavTabs();

            this._setPageLoading(false);
        }

        _initContent(admins, instructors, students, registrations, classes, rooms) {

            this.admins = admins;

            this.instructors = instructors;
            this.directoryTable = this._buildDirectory(this.instructors);

            this.students = students;

            this.registrations =
                registrations
                    .map(registration => {
                        // ensure student is populated
                        if (!registration.student) {
                            registration.student = this.students.find(x => x.id === registration.studentId);
                        }
                        return registration;
                    });
            this.masterScheduleTable = this._buildRegistrationTable(this.registrations);

            this.classes = classes;

            this.rooms = rooms;

            this.adminRegistrationForm = new AdminRegistrationForm(
                this.instructors,
                this.students,
                async data => {
                    const newRegistration = await ApiClient.post(ServerFunctions.registerPrivateLesson, data, x => new Registration(x.newRegistration));

                    // handle response
                    console.log('Registration created:', newRegistration);
                    M.toast({ html: 'Registration created successfully.' });

                    this.registrations.push(newRegistration);
                    this.masterScheduleTable.replaceRange(this.registrations);
                }
            );
        }

        _setPageLoading(isLoading, errorMessage = '') {
            const loadingContainer = document.getElementById('page-loading-container');
            const pageContent = document.getElementById('page-content');
            const pageErrorContent = document.getElementById('page-error-content');
            const pageErrorContentMessage = document.getElementById('page-error-content-message');
            const nav = document.getElementById('nav-mobile');

            loadingContainer.style.display = isLoading ? 'flex' : 'none';
            loadingContainer.hidden = !isLoading;

            pageContent.hidden =
                nav.hidden = !this.currentUser.isOperator || isLoading || errorMessage;

            pageErrorContent.hidden = !errorMessage && !isLoading;
            pageErrorContentMessage.textContent = errorMessage;
        }

        // TODO duplicated
        _setAdminRegistrationLoading(isLoading) {
            const adminRegistrationLoadingContainer = document.getElementById('admin-registration-loading-container');
            const adminRegistrationContainer = document.getElementById('admin-registration-container');

            adminRegistrationLoadingContainer.hidden = !isLoading;
            adminRegistrationContainer.hidden = isLoading;
        }

        _buildRegistrationTable(defaultRegistrations) {
            
            return new Table(
                'master-schedule-table',
                ['Weekday', 'Start Time', 'Length', 'Student', 'Grade', 'Instructor', 'Instrument', /* delete */''],
                // filter
                registration => {
                    // get selected checkboxes within days-of-week-filter-container
                    const daysOfWeekCheckboxes = document.querySelectorAll('#days-of-week-filter-container input[type="checkbox"]');
                    const selectedDays = Array.from(daysOfWeekCheckboxes)
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => checkbox.id);

                    // get selected checkboxes within grade-filter-container
                    const gradeCheckboxes = document.querySelectorAll('#grade-filter-container input[type="checkbox"]');
                    const selectedGrades = Array.from(gradeCheckboxes)
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => checkbox.id * 1);
                    
                    // filter by selected days otherwise all
                    if (selectedDays.length > 0 && !selectedDays.includes(registration.day)) {
                        return false;
                    }

                    // filter by selected grades otherwise all
                    if (selectedGrades.length > 0 && !selectedGrades.includes(registration.student.grade)) {
                        return false;
                    }

                    return true;
                },
                // row
                registration => {
                    const instructor = this.instructors.find(x => x.id === registration.instructorId);
                    const student = this.students.find(x => x.id === registration.studentId);

                    if (!instructor || !student) {
                        console.warn(`Instructor or student not found for registration: ${registration.id}`);
                        return '';
                    }

                    return `
                        <td>${registration.day}</td>
                        <td>${DurationHelpers.stringToDuration(registration.startTime).to12HourFormat()}</td>
                        <td>${registration.length} minutes</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${formatGrade(student.grade)}</td>
                        <td>${instructor.firstName} ${instructor.lastName}</td>
                        <td>${registration.instrument}</td>
                        <td>
                            <a href="#!" class="secondary-content">
                                <i class="delete-registration-table-icon material-icons red-text text-darken-4">delete_forever</i>
                            </a>
                        </td>
                    `;
                },
                // on click
                async event => {
                    if (!event.target.classList.contains('delete-registration-table-icon')) {
                        return;
                    }

                    event.preventDefault();

                    const row = event.target.closest('tr');
                    const registrationIndex = Array.from(row.parentNode.children).indexOf(row);
                    const registrationToDelete = this.registrations[registrationIndex];

                    if (!registrationToDelete) return;

                    await this._requestDeleteRegistrationAsync(registrationToDelete.id);
                },
                [
                    {
                        filterId: 'days-of-week-filter-container',
                        type: 'checkbox'
                    },
                    {
                        filterId: 'grade-filter-container',
                        type: 'checkbox'
                    }
                ],
                defaultRegistrations);
        }

        _buildDirectory(instructors) {
            
            return new Table(
                'directory-table',
                ['Name', 'Email', 'Instrument(s)', 'Phone'],
                // filter
                instructor => {
                    return true;
                },
                // row
                instructor => {
                    return `
                        <td>${instructor.fullName}</td>
                        <td>${instructor.email}</td>
                        <td>${instructor.instruments.join(', ')}</td>
                        <td>${instructor.phone}</td>
                    `;
                },
                null,
                null,
                instructors);
        }

        // TODO duplicated
        _updateSelectOptions(selectId, options, defaultOptionText, forceRefresh = false) {
            const select = document.getElementById(selectId);

            if (!select) {
                console.error(`Select element with ID "${selectId}" not found.`);
                return;
            }

            // get current selected option
            const currentSelectedValue = select.value;

            // Clear existing options
            select.innerHTML = '';

            // Create a default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultOptionText;
            select.appendChild(defaultOption);

            // Populate new options
            options.forEach((option) => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;

                if (!forceRefresh && currentSelectedValue && option.value == currentSelectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

            M.FormSelect.init(select, {
                classes: selectId,
                dropdownOptions: {
                    alignment: 'left',
                    coverTrigger: false,
                    constrainWidth: false
                }
            });
        }

        async _requestDeleteRegistrationAsync(registrationToDeleteId) {

            // confirm delete
            if (!confirm(`Are you sure you want to delete?`)) {
                return;
            }

            try {
                this._setAdminRegistrationLoading(true);

                const response = await ApiClient.post(ServerFunctions.unregisterPrivateLesson, { id: registrationToDeleteId });
                const registrationIndex = this.registrations.findIndex(x => x.id === registrationToDeleteId);

                M.toast({ html: 'Registration deleted successfully.' });
                this.registrations.splice(registrationIndex, 1);
                this.masterScheduleTable.replaceRange(this.registrations);
            } catch (error) {
                console.error('Error deleting registration:', error);
                M.toast({ html: 'Error deleting registration.' });
            } finally {
                this._setAdminRegistrationLoading(false);
            }
        }

        // updateTableAndMessage(tbodyId, data, valueExtractor, rowsPerPage = 10) {
        //     const tbody = document.getElementById(`${tbodyId}-tbody`);
        //     const emptyMessage = document.getElementById(`${tbodyId}-empty-message`);
        //     const paginationContainer = document.getElementById(`${tbodyId}-pagination`);
        //     const table = tbody.closest('table');

        //     if (!data || data.length === 0) {
        //         emptyMessage.hidden = false;
        //         table.hidden = true;
        //         paginationContainer.innerHTML = '';
        //         return;
        //     }

        //     emptyMessage.hidden = true;
        //     table.hidden = false;

        //     // Pagination logic
        //     const totalPages = Math.ceil(data.length / rowsPerPage);
        //     let currentPage = 1;

        //     const renderTableRows = (page) => {
        //         tbody.innerHTML = '';
        //         const start = (page - 1) * rowsPerPage;
        //         const end = start + rowsPerPage;
        //         const rows = data.slice(start, end).map(valueExtractor).map(
        //             cells => {
        //                 const tr = document.createElement('tr');
        //                 cells.forEach((cell) => {
        //                     const td = document.createElement('td');
        //                     td.textContent = cell;
        //                     tr.appendChild(td);
        //                 });
        //                 return tr;
        //             });
        //         rows.forEach((row) => tbody.appendChild(row));
        //     };

        //     const renderPagination = () => {
        //         paginationContainer.innerHTML = '';
        //         const ul = document.createElement('ul');
        //         ul.className = 'pagination';

        //         // Previous button
        //         const prevLi = document.createElement('li');
        //         prevLi.className = currentPage === 1 ? 'disabled' : 'waves-effect';
        //         prevLi.innerHTML = `<a href="#!"><i class="material-icons">chevron_left</i></a>`;
        //         prevLi.addEventListener('click', () => {
        //             if (currentPage > 1) {
        //                 currentPage--;
        //                 renderTableRows(currentPage);
        //                 renderPagination();
        //             }
        //         });
        //         ul.appendChild(prevLi);

        //         // Page numbers
        //         for (let i = 1; i <= totalPages; i++) {
        //             const pageLi = document.createElement('li');
        //             pageLi.className = i === currentPage ? 'active' : 'waves-effect';
        //             pageLi.innerHTML = `<a href="#!">${i}</a>`;
        //             pageLi.addEventListener('click', () => {
        //                 currentPage = i;
        //                 renderTableRows(currentPage);
        //                 renderPagination();
        //             });
        //             ul.appendChild(pageLi);
        //         }

        //         // Next button
        //         const nextLi = document.createElement('li');
        //         nextLi.className = currentPage === totalPages ? 'disabled' : 'waves-effect';
        //         nextLi.innerHTML = `<a href="#!"><i class="material-icons">chevron_right</i></a>`;
        //         nextLi.addEventListener('click', () => {
        //             if (currentPage < totalPages) {
        //                 currentPage++;
        //                 renderTableRows(currentPage);
        //                 renderPagination();
        //             }
        //         });
        //         ul.appendChild(nextLi);

        //         paginationContainer.appendChild(ul);
        //     };

        //     renderTableRows(currentPage);
        //     renderPagination();
        // }

        // setStudents(students) {
        //     this.updateTableAndMessage(
        //         'students-tbody',
        //         'students-empty-message',
        //         studentsData,
        //         (student) => {
        //             const tr = document.createElement('tr');
        //             tr.innerHTML = `
        //                 <td>${student.fullName}</td>
        //                 <td>${student.studentId}</td>
        //                 <td>${student.grade}</td>
        //             `;
        //             return tr;
        //         }
        //     );
        // }

        // setClasses(classes, instructors) {
        //     this.updateTableAndMessage(
        //         'classes-tbody',
        //         'classes-empty-message',
        //         classes,
        //         (classItem) => [classItem.title, instructors.find(x => x.id === classItem.instructorId).fullName, classItem.day]
        //     );
        // }

        // setRegistrations(registrations, students, instructors, rooms) {
        //     this.updateTableAndMessage(
        //         'registrations-tbody',
        //         'registrations-empty-message',
        //         registrations,
        //         (registration) => {
        //             const student = students.find(x => x.id === registration.studentId);
        //             const instructor = instructors.find(x => x.id === registration.instructorId);
        //             const room = rooms.find(x => x.id === registration.roomId);

        //             return [
        //                 student.fullName,
        //                 instructor.fullName,
        //                 room.formattedName,
        //                 registration.instrument
        //             ];
        //         }
        //     );
        // }

        // setRooms(rooms) {
        //     this.updateTableAndMessage(
        //         'rooms-tbody',
        //         'rooms-empty-message',
        //         rooms,
        //         (room) => [room.formattedName]
        //     );
        // }
    }
</script>