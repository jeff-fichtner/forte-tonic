<script>
    class ViewModel {

        async initializeAsync() {
            
            const authenticatedUser = await HttpService.fetch(ServerFunctions.getAuthenticatedUser, x => new AuthenticatedUserResponse(x));

            const validations = [
                [authenticatedUser, 'No authenticated user received.', `Must authorize use of email address.`],
            ];

            for (const [condition, errorMessage, alertMessage] of validations) {
                if (!condition) {
                    console.error(errorMessage);
                    alert(alertMessage);
                    await DomHelpers._waitForDocumentReadyAsync();
                    await this._setPageLoading(false, errorMessage);
                    return;
                }
            }

            console.log(`Authenticated user: ${JSON.stringify(authenticatedUser)}`);

            this.dbClient = new IndexedDbClient(
                'forte',
                [DataStores.STUDENTS]
            );
            await this.dbClient.init();

            const [
                _,
                admins,
                instructors,
                students,
                registrations,
                classes,
                rooms
            ] =
                await Promise.all([
                    DomHelpers._waitForDocumentReadyAsync(),
                    HttpService.fetch(ServerFunctions.getAdmins, x => x.map(y => new Admin(y))),
                    HttpService.fetch(ServerFunctions.getInstructors, x => x.map(y => new Instructor(y))),
                    this._getStudents(),
                    HttpService.fetchAllPages(ServerFunctions.getRegistrations, x => new Registration(x)),
                    HttpService.fetch(ServerFunctions.getClasses, x => x.map(y => new Class(y))),
                    HttpService.fetch(ServerFunctions.getRooms, x => x.map(y => new Room(y))),
                ]);

            M.AutoInit();

            this.currentUser = authenticatedUser;
            this.admins = admins;
            this.instructors = instructors;
            this.students = students;
            this.registrations =
                registrations
                    .map(registration => {
                        // ensure student is populated
                        if (!registration.student) {
                            registration.student = this.students.find(x => x.id === registration.studentId);
                        }
                        return registration;
                    });
            this.classes = classes;
            this.rooms = rooms;

            let defaultSection;
            if (authenticatedUser.shouldShowAsOperator || authenticatedUser.admin) {
                console.log('Initializing admin content...');
                this._initAdminContent();
                defaultSection = Sections.ADMIN;
            }

            if (authenticatedUser.shouldShowAsOperator || authenticatedUser.instructor) {
                console.log('Initializing instructor content...');
                this._initInstructorContent();
                defaultSection = Sections.INSTRUCTOR;
            }

            if (authenticatedUser.shouldShowAsOperator || authenticatedUser.parent) {
                console.log('Initializing parent content...');
                this._initParentContent();
                defaultSection = Sections.PARENT;
            }

            const defaultSectionToUse = !authenticatedUser.shouldShowAsOperator ? defaultSection : null;
            console.log(`Default section to use: ${defaultSectionToUse}`);

            this.navTabs = new NavTabs(defaultSectionToUse);

            this._setPageLoading(false);
        }

        _initAdminContent() {

            // master schedule tab
            this.masterScheduleTable = this._buildRegistrationTable(this.registrations);

            // registration form
            this.adminRegistrationForm = new AdminRegistrationForm(
                this.instructors,
                this.students,
                this.classes,
                async data => {
                    const newRegistration = await HttpService.post(ServerFunctions.register, data, x => new Registration(x.newRegistration));
                    
                    // handle response
                    console.log('Registration created:', newRegistration);
                    M.toast({ html: 'Registration created successfully.' });

                    this.registrations.push(newRegistration);
                    this.masterScheduleTable.replaceRange(this.registrations);
                }
            );

            // weekly schedule

            // directory
            const mappedEmployees =
                this.adminEmployees()
                    .concat(this.instructors.map(this.instructorToEmployee));

            this.employeeDirectoryTable = this._buildDirectory('employee-directory-table', mappedEmployees);
        }

        _initInstructorContent() {
            // weekly schedule
            // unique days registrations
            const daysWithRegistrations = this.registrations
                .map(registration => registration.day)
                .filter((day, index, self) => self.indexOf(day) === index);
            
            const instructorWeeklyScheduleTables = document.getElementById('instructor-weekly-schedule-tables');
            
            // TODO future will allow redraw
            daysWithRegistrations.forEach(day => {
                const tableId = `instructor-weekly-schedule-table-${day}`;
                const newTable = document.createElement('table');
                newTable.id = tableId;
                instructorWeeklyScheduleTables.appendChild(newTable);
                debugger
                this._buildWeeklySchedule(tableId, this.registrations.filter(x => x.day === day));
            });

            debugger
            // attendance

            // directory
            const mappedEmployees =
                this.adminEmployees()
                    .concat(this.instructors.map(this.instructorToEmployee));

            // this may be set in admin section if user is operator
            this.employeeDirectoryTable ??= this._buildDirectory('employee-directory-table', mappedEmployees);
        }

        _initParentContent() {
            // weekly schedule
            // this.parentWeeklyScheduleTable = this._buildWeeklySchedule('parent-weekly-schedule-table', this.registrations);

            // registration

            // directory
            const mappedEmployees =
                this.adminEmployees()
                    .concat(this.instructors
                        .filter(instructor => this.registrations.some(registration => registration.instructorId === instructor.id))
                        .map(this.instructorToEmployee));

            this.parentDirectoryTable = this._buildDirectory('parent-directory-table', mappedEmployees);
        }

        _setPageLoading(isLoading, errorMessage = '') {
            const loadingContainer = document.getElementById('page-loading-container');
            const pageContent = document.getElementById('page-content');
            const pageErrorContent = document.getElementById('page-error-content');
            const pageErrorContentMessage = document.getElementById('page-error-content-message');
            const nav = document.getElementById('nav-mobile');

            loadingContainer.style.display = isLoading ? 'flex' : 'none';
            loadingContainer.hidden = !isLoading;

            pageContent.hidden = isLoading || errorMessage;
            nav.hidden = !this.currentUser.shouldShowAsOperator || isLoading || errorMessage;

            pageErrorContent.hidden = !errorMessage && !isLoading;
            pageErrorContentMessage.textContent = errorMessage;
        }

        // TODO duplicated (will be consolidated elsewhere)
        _setAdminRegistrationLoading(isLoading) {
            const adminRegistrationLoadingContainer = document.getElementById('admin-registration-loading-container');
            const adminRegistrationContainer = document.getElementById('admin-registration-container');

            adminRegistrationLoadingContainer.hidden = !isLoading;
            adminRegistrationContainer.hidden = isLoading;
        }

        _buildRegistrationTable(defaultRegistrations) {

            return new Table(
                'master-schedule-table',
                ['Weekday', 'Start Time', 'Length', 'Student', 'Grade', 'Instructor', 'Instrument/Class', 'Contact', 'Remove'],
                // row
                registration => {
                    const instructor = this.instructors.find(x => x.id === registration.instructorId);
                    const student = this.students.find(x => x.id === registration.studentId);

                    if (!instructor || !student) {
                        console.warn(`Instructor or student not found for registration: ${registration.id}`);
                        return '';
                    }

                    return `
                        <td>${registration.day}</td>
                        <td>${registration.formattedStartTime}</td>
                        <td>${registration.length} min</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.formattedGrade}</td>
                        <td>${instructor.firstName} ${instructor.lastName}</td>
                        <td>${registration.registrationType === RegistrationType.GROUP ? registration.className : registration.instrument}</td>
                        <td>
                            <a href="#!">
                                <i class="copy-parent-emails-table-icon material-icons gray-text text-darken-4">email</i>
                            </a>
                        </td>
                        <td>
                            <a href="#!">
                                <i class="delete-registration-table-icon material-icons red-text text-darken-4">delete_forever</i>
                            </a>
                        </td>
                    `;
                },
                defaultRegistrations,
                // on click
                async event => {
                    const isCopy = event.target.classList.contains('copy-parent-emails-table-icon');
                    const isDelete = event.target.classList.contains('delete-registration-table-icon');
                    if (!isCopy && !isDelete) {
                        return;
                    }

                    event.preventDefault();

                    const row = event.target.closest('tr');
                    const registrationIndex = Array.from(row.parentNode.children).indexOf(row);
                    const currentRegistration = this.registrations[registrationIndex];

                    if (!currentRegistration) return;

                    if (isCopy) {
                        const parentEmails = currentRegistration.student.parentEmails;
                        await this._copyToClipboard(parentEmails);
                        return;
                    }

                    if (isDelete) {
                        await this._requestDeleteRegistrationAsync(currentRegistration.id);
                        return;
                    }
                },
                // filter
                registration => {
                    // // get selected checkboxes within days-of-week-filter-container
                    // const daysOfWeekCheckboxes = document.querySelectorAll('#days-of-week-filter-container input[type="checkbox"]');
                    // const selectedDays = Array.from(daysOfWeekCheckboxes)
                    //     .filter(checkbox => checkbox.checked)
                    //     .map(checkbox => checkbox.id);

                    // // get selected checkboxes within grade-filter-container
                    // const gradeCheckboxes = document.querySelectorAll('#grade-filter-container input[type="checkbox"]');
                    // const selectedGrades = Array.from(gradeCheckboxes)
                    //     .filter(checkbox => checkbox.checked)
                    //     .map(checkbox => checkbox.id * 1);

                    // // filter by selected days otherwise all
                    // if (selectedDays.length > 0 && !selectedDays.includes(registration.day)) {
                    //     return false;
                    // }

                    // // filter by selected grades otherwise all
                    // if (selectedGrades.length > 0 && !selectedGrades.includes(registration.student.grade)) {
                    //     return false;
                    // }

                    return true;
                },
                [
                    // {
                    //     filterId: 'days-of-week-filter-container',
                    //     type: 'checkbox'
                    // },
                    // {
                    //     filterId: 'grade-filter-container',
                    //     type: 'checkbox'
                    // }
                ]);
        }

        _buildWeeklySchedule(tableId, enrollments) {

            return new Table(
                tableId,
                ['Weekday', 'Start Time', 'Length', 'Student', 'Grade', 'Instructor', 'Instrument'],
                // row
                enrollment => {
                    const instructor = this.instructors.find(x => x.id === enrollment.instructorId);
                    const student = this.students.find(x => x.id === enrollment.studentId);

                    if (!instructor || !student) {
                        console.warn(`Instructor or student not found for enrollment: ${enrollment.id}`);
                        return '';
                    }

                    return `
                        <td>${enrollment.day}</td>
                        <td>${enrollment.formattedStartTime}</td>
                        <td>${enrollment.length} minutes</td>
                        <td>${student.fullName}</td>
                        <td>${student.formattedGrade}</td>
                        <td>${instructor.fullName}</td>
                        <td>${enrollment.instrument}</td>
                    `;
                },
                enrollments);
        }

        _buildDirectory(tableId, employees) {

            return new Table(
                tableId,
                ['Name', 'Role', 'Email', 'Phone', 'Contact'],
                // row
                employee => {
                    return `
                        <td>${employee.fullName}</td>
                        <td>${employee.roles.join(', ')}</td>
                        <td>${employee.email}</td>
                        <td>${employee.phone}</td>
                        <td>
                            <a href="#!">
                                <i class="copy-parent-emails-table-icon material-icons gray-text text-darken-4">email</i>
                            </a>
                        </td>
                    `;
                },
                employees);
        }

        // TODO duplicated (will be consolidated elsewhere)
        _updateSelectOptions(selectId, options, defaultOptionText, forceRefresh = false) {
            const select = document.getElementById(selectId);

            if (!select) {
                console.error(`Select element with ID "${selectId}" not found.`);
                return;
            }

            // get current selected option
            const currentSelectedValue = select.value;

            // Clear existing options
            select.innerHTML = '';

            // Create a default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultOptionText;
            select.appendChild(defaultOption);

            // Populate new options
            options.forEach((option) => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;

                if (!forceRefresh && currentSelectedValue && option.value == currentSelectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

            M.FormSelect.init(select, {
                classes: selectId,
                dropdownOptions: {
                    alignment: 'left',
                    coverTrigger: false,
                    constrainWidth: false
                }
            });
        }

        async _requestDeleteRegistrationAsync(registrationToDeleteId) {

            // confirm delete
            if (!confirm(`Are you sure you want to delete?`)) {
                return;
            }

            try {
                this._setAdminRegistrationLoading(true);

                const response = await HttpService.post(ServerFunctions.unregister, { id: registrationToDeleteId });
                const registrationIndex = this.registrations.findIndex(x => x.id === registrationToDeleteId);

                M.toast({ html: 'Registration deleted successfully.' });
                this.registrations.splice(registrationIndex, 1);
                this.masterScheduleTable.replaceRange(this.registrations);
            } catch (error) {
                console.error('Error deleting registration:', error);
                M.toast({ html: 'Error deleting registration.' });
            } finally {
                this._setAdminRegistrationLoading(false);
            }
        }

        async _copyToClipboard(text) {
            try {
                // Attempt to use the Clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    M.toast({ html: `Copied '${text}' to clipboard.` });
                    return;
                }
            } catch (error) {
                console.error('Failed to copy text to clipboard WITH MODERN API:', error);
            }

            try {
                // Fallback to execCommand for older browsers
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                M.toast({ html: `Copied '${text}' to clipboard.` });
            } catch (error) {
                console.error('Failed to copy text to clipboard WITH FALLBACK:', error);
                M.toast({ html: 'Failed to copy text to clipboard.' });
            }
        };

        adminEmployees() {
            const noah = this.admins.find(admin => admin.email === 'ndemosslevy@mcds.org'); // TODO migrate to data column

            return this.admins
                .map(x => {
                    if (x === noah) {
                        return {
                            id: x.id,
                            fullName: x.fullName,
                            email: x.email,
                            phone: '(415) 945-5121', // TODO migrate to data column
                            roles: ['Forte Director'] // TODO migrate to data column
                        };
                    }

                    return {
                        id: x.id,
                        fullName: x.fullName,
                        email: 'forte@mcds.org', // TODO migrate to data column
                        phone: '(415) 945-5122', // TODO migrate to data column
                        roles: ['Forte Associate Manager'] // TODO migrate to data column
                    };
                });
        }

        instructorToEmployee(instructor) {
            return {
                id: instructor.id,
                fullName: instructor.fullName,
                email: instructor.email,
                phone: instructor.phone,
                roles: instructor.instruments
            };
        }

        async _getStudents(forceRefresh = false) {
            // load students from indexeddb
            if (!forceRefresh && await this.dbClient.hasItems(DataStores.STUDENTS)) {
                console.log('Loading students from IndexedDB...');
                const items = await this.dbClient.getAll(DataStores.STUDENTS, x => new Student(x));
                if (!items || items.length === 0) {
                    console.warn('No students found in IndexedDB.');
                } else {
                    console.log(`Loaded ${items.length} students from IndexedDB.`);
                }
                return items;
            }

            const students = await HttpService.fetchAllPages(ServerFunctions.getStudents, x => new Student(x));
            console.log(`Fetched ${students.length} students from server.`);
            if (students.length > 0) {
                // save students to indexeddb
                console.log('Saving students to IndexedDB...');
                await this.dbClient.insertRange(DataStores.STUDENTS, students);
            } else {
                console.warn('No students found from server.');
            }

            return students;
        }
    }
</script>