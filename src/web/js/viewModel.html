<script>
    class ViewModel {

        async initializeAsync() {

            const authenticatedUser = await ApiClient.fetch(ServerFunctions.getAuthenticatedUser, x => new AuthenticatedUserResponse(x));

            const validations = [
                [authenticatedUser, 'No authenticated user received.', `Must authorize use of email address.`],
            ];

            for (const [condition, errorMessage, alertMessage] of validations) {
                if (!condition) {
                    console.error(errorMessage);
                    alert(alertMessage);
                    await DomHelpers._waitForDocumentReadyAsync();
                    await this._setPageLoading(false, errorMessage);
                    return;
                }
            }

            console.log(`Authenticated user: ${JSON.stringify(authenticatedUser)}`);

            const [
                _,
                admins,
                instructors,
                students,
                registrations,
                classes,
                rooms
            ] =
                await Promise.all([
                    DomHelpers._waitForDocumentReadyAsync(),
                    ApiClient.fetch(ServerFunctions.getAdmins, x => x.map(y => new Admin(y))),
                    ApiClient.fetch(ServerFunctions.getInstructors, x => x.map(y => new Instructor(y))),
                    ApiClient.fetchAllPages(ServerFunctions.getStudents, x => new Student(x)),
                    ApiClient.fetchAllPages(ServerFunctions.getRegistrations, x => new Registration(x)),
                    ApiClient.fetch(ServerFunctions.getClasses, x => x.map(y => new Class(y))),
                    ApiClient.fetch(ServerFunctions.getRooms, x => x.map(y => new Room(y)))
                ]);

            M.AutoInit();

            this.currentUser = authenticatedUser;
            this.admins = admins;
            this.instructors = instructors;
            this.students = students;
            this.registrations =
                registrations
                    .map(registration => {
                        // ensure student is populated
                        if (!registration.student) {
                            registration.student = this.students.find(x => x.id === registration.studentId);
                        }
                        return registration;
                    });
            this.classes = classes;
            this.rooms = rooms;

            let defaultSection;
            if (authenticatedUser.shouldShowAsOperator || authenticatedUser.admin) {
                console.log('Initializing admin content...');
                this._initAdminContent();
                defaultSection = Sections.ADMIN;
            }
            
            if (authenticatedUser.shouldShowAsOperator || authenticatedUser.instructor) {
                console.log('Initializing instructor content...');
                this._initInstructorContent();
                defaultSection = Sections.INSTRUCTOR;
            }
            
            if (authenticatedUser.shouldShowAsOperator || authenticatedUser.parent) {
                console.log('Initializing parent content...');
                this._initParentContent();
                defaultSection = Sections.PARENT;
            }

            const defaultSectionToUse = !authenticatedUser.shouldShowAsOperator ? defaultSection : null;
            console.log(`Default section to use: ${defaultSectionToUse}`);

            this.navTabs = new NavTabs(defaultSectionToUse);

            this._setPageLoading(false);
        }

        _initAdminContent() {

            // master schedule tab
            this.masterScheduleTable = this._buildRegistrationTable(this.registrations);

            // registration form
            this.adminRegistrationForm = new AdminRegistrationForm(
                this.instructors,
                this.students,
                async data => {
                    const newRegistration = await ApiClient.post(ServerFunctions.registerPrivateLesson, data, x => new Registration(x.newRegistration));

                    // handle response
                    console.log('Registration created:', newRegistration);
                    M.toast({ html: 'Registration created successfully.' });

                    this.registrations.push(newRegistration);
                    this.masterScheduleTable.replaceRange(this.registrations);
                }
            );

            // weekly schedule

            // directory
            const mappedEmployees =
                this.admins.map(this.adminToEmployee)
                    .concat(this.instructors.map(this.instructorToEmployee));

            this.employeeDirectoryTable = this._buildDirectory('employee-directory-table', mappedEmployees);
        }

        _initInstructorContent() {
            // weekly schedule

            // attendance

            // directory
            const mappedEmployees =
                this.admins
                    .map(this.adminToEmployee)
                    .concat(this.instructors.map(this.instructorToEmployee));

            // this may be set in admin section if user is operator
            this.employeeDirectoryTable ??= this._buildDirectory('employee-directory-table', mappedEmployees);
        }

        _initParentContent() {
            // weekly schedule

            // registration

            // directory
            const mappedEmployees =
                this.admins
                    .map(this.adminToEmployee)
                    .concat(this.instructors
                        .filter(instructor => this.registrations.some(registration => registration.instructorId === instructor.id))
                        .map(this.instructorToEmployee));
            
            this.parentDirectoryTable = this._buildDirectory('parent-directory-table', mappedEmployees);
        }

        _setPageLoading(isLoading, errorMessage = '') {
            const loadingContainer = document.getElementById('page-loading-container');
            const pageContent = document.getElementById('page-content');
            const pageErrorContent = document.getElementById('page-error-content');
            const pageErrorContentMessage = document.getElementById('page-error-content-message');
            const nav = document.getElementById('nav-mobile');

            loadingContainer.style.display = isLoading ? 'flex' : 'none';
            loadingContainer.hidden = !isLoading;

            pageContent.hidden = isLoading || errorMessage;
            nav.hidden = !this.currentUser.shouldShowAsOperator || isLoading || errorMessage;

            pageErrorContent.hidden = !errorMessage && !isLoading;
            pageErrorContentMessage.textContent = errorMessage;
        }

        // TODO duplicated (will be consolidated elsewhere)
        _setAdminRegistrationLoading(isLoading) {
            const adminRegistrationLoadingContainer = document.getElementById('admin-registration-loading-container');
            const adminRegistrationContainer = document.getElementById('admin-registration-container');

            adminRegistrationLoadingContainer.hidden = !isLoading;
            adminRegistrationContainer.hidden = isLoading;
        }

        _buildRegistrationTable(defaultRegistrations) {

            return new Table(
                'master-schedule-table',
                ['Weekday', 'Start Time', 'Length', 'Student', 'Grade', 'Instructor', 'Instrument', /* delete */''],
                // filter
                registration => {
                    // get selected checkboxes within days-of-week-filter-container
                    const daysOfWeekCheckboxes = document.querySelectorAll('#days-of-week-filter-container input[type="checkbox"]');
                    const selectedDays = Array.from(daysOfWeekCheckboxes)
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => checkbox.id);

                    // get selected checkboxes within grade-filter-container
                    const gradeCheckboxes = document.querySelectorAll('#grade-filter-container input[type="checkbox"]');
                    const selectedGrades = Array.from(gradeCheckboxes)
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => checkbox.id * 1);

                    // filter by selected days otherwise all
                    if (selectedDays.length > 0 && !selectedDays.includes(registration.day)) {
                        return false;
                    }

                    // filter by selected grades otherwise all
                    if (selectedGrades.length > 0 && !selectedGrades.includes(registration.student.grade)) {
                        return false;
                    }

                    return true;
                },
                // row
                registration => {
                    const instructor = this.instructors.find(x => x.id === registration.instructorId);
                    const student = this.students.find(x => x.id === registration.studentId);

                    if (!instructor || !student) {
                        console.warn(`Instructor or student not found for registration: ${registration.id}`);
                        return '';
                    }

                    return `
                        <td>${registration.day}</td>
                        <td>${DurationHelpers.stringToDuration(registration.startTime).to12HourFormat()}</td>
                        <td>${registration.length} minutes</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${formatGrade(student.grade)}</td>
                        <td>${instructor.firstName} ${instructor.lastName}</td>
                        <td>${registration.instrument}</td>
                        <td>
                            <a href="#!" class="secondary-content">
                                <i class="delete-registration-table-icon material-icons red-text text-darken-4">delete_forever</i>
                            </a>
                        </td>
                    `;
                },
                // on click
                async event => {
                    if (!event.target.classList.contains('delete-registration-table-icon')) {
                        return;
                    }

                    event.preventDefault();

                    const row = event.target.closest('tr');
                    const registrationIndex = Array.from(row.parentNode.children).indexOf(row);
                    const registrationToDelete = this.registrations[registrationIndex];

                    if (!registrationToDelete) return;

                    await this._requestDeleteRegistrationAsync(registrationToDelete.id);
                },
                [
                    {
                        filterId: 'days-of-week-filter-container',
                        type: 'checkbox'
                    },
                    {
                        filterId: 'grade-filter-container',
                        type: 'checkbox'
                    }
                ],
                defaultRegistrations);
        }

        _buildDirectory(tableId, employees) {

            return new Table(
                tableId,
                ['Name', 'Email', 'Role', 'Phone'],
                // filter
                employee => {
                    return true;
                },
                // row
                employee => {
                    return `
                        <td>${employee.fullName}</td>
                        <td>${employee.email}</td>
                        <td>${employee.instruments.join(', ')}</td>
                        <td>${employee.phone}</td>
                    `;
                },
                null,
                null,
                employees);
        }

        // TODO duplicated (will be consolidated elsewhere)
        _updateSelectOptions(selectId, options, defaultOptionText, forceRefresh = false) {
            const select = document.getElementById(selectId);

            if (!select) {
                console.error(`Select element with ID "${selectId}" not found.`);
                return;
            }

            // get current selected option
            const currentSelectedValue = select.value;

            // Clear existing options
            select.innerHTML = '';

            // Create a default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultOptionText;
            select.appendChild(defaultOption);

            // Populate new options
            options.forEach((option) => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;

                if (!forceRefresh && currentSelectedValue && option.value == currentSelectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

            M.FormSelect.init(select, {
                classes: selectId,
                dropdownOptions: {
                    alignment: 'left',
                    coverTrigger: false,
                    constrainWidth: false
                }
            });
        }

        async _requestDeleteRegistrationAsync(registrationToDeleteId) {

            // confirm delete
            if (!confirm(`Are you sure you want to delete?`)) {
                return;
            }

            try {
                this._setAdminRegistrationLoading(true);

                const response = await ApiClient.post(ServerFunctions.unregisterPrivateLesson, { id: registrationToDeleteId });
                const registrationIndex = this.registrations.findIndex(x => x.id === registrationToDeleteId);

                M.toast({ html: 'Registration deleted successfully.' });
                this.registrations.splice(registrationIndex, 1);
                this.masterScheduleTable.replaceRange(this.registrations);
            } catch (error) {
                console.error('Error deleting registration:', error);
                M.toast({ html: 'Error deleting registration.' });
            } finally {
                this._setAdminRegistrationLoading(false);
            }
        }

        adminToEmployee(admin) {
            return {
                id: admin.id,
                fullName: admin.fullName,
                email: admin.email,
                phone: admin.phone,
                instruments: ['Admin']
            };
        }

        instructorToEmployee(instructor) {
            return {
                id: instructor.id,
                fullName: instructor.fullName,
                email: instructor.email,
                phone: instructor.phone,
                instruments: instructor.instruments
            };
        }
    }
</script>