<script>
    class HttpClient {
        static fetch(serverFunctionName, mapper = null, context = null, paginationOptions = {}, ...args) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler((response) => {
                        if (!response) {
                            reject(new Error('Successful but empty response'));
                            return;
                        }

                        try {
                            const parsedResponse = JSON.parse(response);
                            resolve(mapper ? mapper(parsedResponse) : parsedResponse);

                        } catch (e) {
                            reject(new Error(`Error - ${e}: ${response}`));
                        }
                    })
                    .withFailureHandler((error) => reject(error))
                    .withUserObject(context)[serverFunctionName](
                        ...(paginationOptions ? [paginationOptions, ...args] : args)
                    );
            });
        }

        static async fetchPage(serverFunctionName, mapper, context = null, page = 0, pageSize = 10, ...args) {
            try {
                const paginationOptions = { page, pageSize };
                const response = await this.fetch(serverFunctionName, null, context, paginationOptions, ...args);
                if (!response) {
                    return { data: [], total: 0 };
                }

                const parsedResults = response.data.map(y => mapper(y));
                return {
                    data: parsedResults,
                    total: response.total || 0,
                };
            } catch (error) {
                console.error(`Error fetching page ${page}:`, error);
                throw error;
            }
        }

        static async fetchAllPages(serverFunctionName, mapper, context = null, pageSize = 10, ...args) {
            let allResults = [];
            let currentPage = 0;
            let totalPages = null;

            while (!totalPages || currentPage < totalPages) {
                try {
                    const { data, total } = await this.fetchPage(serverFunctionName, mapper, context, currentPage, pageSize, ...args);

                    if (!data || data.length === 0) {
                        break;
                    }

                    allResults = allResults.concat(data);

                    if (!totalPages && total !== undefined) {
                        totalPages = Math.ceil(total / pageSize);
                    }

                    if (!totalPages) {
                        throw new Error('Total pages not defined');
                    }

                    currentPage++;
                } catch (error) {
                    console.error(`Error fetching all pages at page ${currentPage}:`, error);
                    return [];
                }
            }

            return allResults;
        }
    }

</script>