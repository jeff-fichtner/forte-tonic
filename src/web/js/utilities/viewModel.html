<script>
    class ViewModel {

        async initializeAsync() {

            const [
                _,
                authenticatedUser,
                instructors,
                registrations
            ] =
                await Promise.all([
                    PromiseHelpers.promisifyEvent('DOMContentLoaded', document),
                    ApiClient.fetch(ServerFunctions.getAuthenticatedUser, x => new AuthenticatedUserResponse(x)),
                    ApiClient.fetchAllPages(ServerFunctions.getInstructors, x => new Instructor(x)),
                    ApiClient.fetchAllPages(ServerFunctions.getRegistrations, x => new Registration(x)),
                    // fetchAllPages(ServerFunctions.getStudents),
                    // fetchAllPages(ServerFunctions.getClasses, x => new Class(x)),
                    // fetchAllPages(ServerFunctions.getRooms, x => new Room(x))
                ]);

            this.instructors = instructors;
            this._setInstructorOptions(instructors);

            this.registrations = registrations;
            this._setRegistrations(registrations);

            M.AutoInit();
            this.initTabs();

            this.registerListeners();

            this.setLoading(false);
        }

        initTabs() {
            const tabsContainer = document.querySelector('.tabs');
            const tabs = document.querySelectorAll('.tabs .tab a');
            const tabContents = document.querySelectorAll('.tab-content');

            if (!tabsContainer || tabs.length === 0) return;

            tabs.forEach((tab) => {
                tab.addEventListener('click', (event) => {
                    event.preventDefault();
                    const targetTab = tab.getAttribute('href');
                    const targetContent = document.querySelector(targetTab);

                    // Hide all tab contents
                    tabContents.forEach((content) => {
                        content.style.display = 'none';
                    });

                    // Show the selected tab content
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }

                    // Remove active class from all tabs and add it to the clicked tab
                    tabs.forEach((t) => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            // Show the first tab and its content by default
            if (tabs.length > 0) {
                tabs[0].click();
            }
        }

        setLoading(isLoading) {
            const loadingElement = document.getElementById('loading');
            const registrationForm = document.getElementById('new-registration-form');

            loadingElement.style.display = isLoading ? 'block' : 'none';
            registrationForm.hidden = isLoading;
        }

        // updateTableAndMessage(tbodyId, data, valueExtractor, rowsPerPage = 10) {
        //     const tbody = document.getElementById(`${tbodyId}-tbody`);
        //     const emptyMessage = document.getElementById(`${tbodyId}-empty-message`);
        //     const paginationContainer = document.getElementById(`${tbodyId}-pagination`);
        //     const table = tbody.closest('table');

        //     if (!data || data.length === 0) {
        //         emptyMessage.hidden = false;
        //         table.hidden = true;
        //         paginationContainer.innerHTML = '';
        //         return;
        //     }

        //     emptyMessage.hidden = true;
        //     table.hidden = false;

        //     // Pagination logic
        //     const totalPages = Math.ceil(data.length / rowsPerPage);
        //     let currentPage = 1;

        //     const renderTableRows = (page) => {
        //         tbody.innerHTML = '';
        //         const start = (page - 1) * rowsPerPage;
        //         const end = start + rowsPerPage;
        //         const rows = data.slice(start, end).map(valueExtractor).map(
        //             cells => {
        //                 const tr = document.createElement('tr');
        //                 cells.forEach((cell) => {
        //                     const td = document.createElement('td');
        //                     td.textContent = cell;
        //                     tr.appendChild(td);
        //                 });
        //                 return tr;
        //             });
        //         rows.forEach((row) => tbody.appendChild(row));
        //     };

        //     const renderPagination = () => {
        //         paginationContainer.innerHTML = '';
        //         const ul = document.createElement('ul');
        //         ul.className = 'pagination';

        //         // Previous button
        //         const prevLi = document.createElement('li');
        //         prevLi.className = currentPage === 1 ? 'disabled' : 'waves-effect';
        //         prevLi.innerHTML = `<a href="#!"><i class="material-icons">chevron_left</i></a>`;
        //         prevLi.addEventListener('click', () => {
        //             if (currentPage > 1) {
        //                 currentPage--;
        //                 renderTableRows(currentPage);
        //                 renderPagination();
        //             }
        //         });
        //         ul.appendChild(prevLi);

        //         // Page numbers
        //         for (let i = 1; i <= totalPages; i++) {
        //             const pageLi = document.createElement('li');
        //             pageLi.className = i === currentPage ? 'active' : 'waves-effect';
        //             pageLi.innerHTML = `<a href="#!">${i}</a>`;
        //             pageLi.addEventListener('click', () => {
        //                 currentPage = i;
        //                 renderTableRows(currentPage);
        //                 renderPagination();
        //             });
        //             ul.appendChild(pageLi);
        //         }

        //         // Next button
        //         const nextLi = document.createElement('li');
        //         nextLi.className = currentPage === totalPages ? 'disabled' : 'waves-effect';
        //         nextLi.innerHTML = `<a href="#!"><i class="material-icons">chevron_right</i></a>`;
        //         nextLi.addEventListener('click', () => {
        //             if (currentPage < totalPages) {
        //                 currentPage++;
        //                 renderTableRows(currentPage);
        //                 renderPagination();
        //             }
        //         });
        //         ul.appendChild(nextLi);

        //         paginationContainer.appendChild(ul);
        //     };

        //     renderTableRows(currentPage);
        //     renderPagination();
        // }

        setInstructors(instructors) {
            this.updateTableAndMessage(
                'instructors',
                instructors,
                (instructor) => [instructor.fullName, instructor.email, instructor.instrument1]
            );
        }

        registerListeners() {

            document.getElementById('student-search-btn').addEventListener('click', (event) => {
                event.preventDefault();

                let data = {
                    name: document.getElementById('student-search').value
                };

                ApiClient.post(ServerFunctions.searchStudentsByName, data, x => x.map(y => new Student(y)))
                    .then(students => {
                        if (students.length) {
                            this._setStudentOptions(students);
                        }
                    })
                    .catch(error => {
                        console.error('Error searching students:', error);
                    });
            });

            document.getElementById('student-search').addEventListener('input', (event) => {
                event.preventDefault();
                const searchValue = event.target.value.trim();
                const searchButton = document.getElementById('student-search-btn');
                searchButton.classList.toggle('disabled', searchValue.length < 2);
            });

            document.getElementById('student-select-options-container').addEventListener('change', (event) => {
                event.preventDefault();
                if (event.target.id === 'student-select') {
                    const selectedValue = event.target.value;
                    const submitButton = document.getElementById('select-student-modal-submit-btn');
                    submitButton.classList.toggle('disabled', !selectedValue);
                }
            });

            document.getElementById('select-student-modal-submit-btn').addEventListener('click', (event) => {
                event.preventDefault();
                const select = document.getElementById('student-select');
                const selectedOption = select.options[select.selectedIndex];
                const selectedStudentId = select.value;

                if (!selectedStudentId) {
                    M.toast({ html: 'Please select a student.' });
                    return;
                }

                const modalInstance = M.Modal.getInstance(document.getElementById('student-select-modal'));
                modalInstance.close();

                this.selectedStudentId = selectedStudentId;
                const studentNameSpan = document.getElementById('selected-student-name-span');
                studentNameSpan.textContent = selectedOption.textContent;

                const studentNameSpanContainer = document.getElementById('selected-student-name-span-container');
                studentNameSpanContainer.hidden = false;

                this._setStudentOptions([]);

                // validate page
                this._validateRegistration();
            });

            document.getElementById('instructor-select-options-container').addEventListener('change', (event) => {
                event.preventDefault();
                if (event.target.id === 'instructor-select') {
                    const selectedValue = event.target.value;

                    const currentInstructor = this.instructors.find(x => x.id === selectedValue);
                    this._setInstructorInstrumentOptions(currentInstructor);
                    this._setInstructorDayOptions(currentInstructor);

                    this._validateInstructionInfo();

                    const instructorDaySelectedInfoContainer = document.getElementById('instructor-day-selected-info-container');
                    instructorDaySelectedInfoContainer.hidden = true;

                    const infoContainer = document.getElementById('instructor-selected-info-container');
                    infoContainer.hidden = !selectedValue;
                }
            });

            document.getElementById('instructor-day-select-options-container').addEventListener('change', (event) => {
                event.preventDefault();
                if (event.target.id === 'day-select') {
                    const selectedValue = event.target.value;
                    const selectedInstructorId = selectedValue.split('_')[0];
                    const selectedDay = selectedValue.split('_')[1];

                    const currentInstructor = this.instructors.find(x => x.id === selectedInstructorId);
                    this._setInstructorDayStartTimeOptions(currentInstructor, selectedDay);

                    this._validateInstructionInfo();

                    const instructorDaySelectedInfoContainer = document.getElementById('instructor-day-selected-info-container');
                    instructorDaySelectedInfoContainer.hidden = !selectedValue;
                }
            });

            document.getElementById('instrument-select-options-container').addEventListener('change', (event) => {
                event.preventDefault();
                if (event.target.id === 'instrument-select') {
                    const selectedValue = event.target.value;
                    console.log('Instrument changed to:', selectedValue);

                    this._validateInstructionInfo();
                }
            });

            document.getElementById('instructor-day-start-time-container').addEventListener('change', (event) => {
                if (event.target.id === 'start-time-select') {
                    const selectedValue = event.target.value;
                    console.log('Start time changed to:', selectedValue);
                    this._validateInstructionInfo();
                }
            });

            document.getElementById('lesson-length-container').addEventListener('change', (event) => {
                if (event.target.type === 'radio') {
                    const selectedValue = event.target.value;
                    console.log('Radio changed to:', selectedValue);

                    this._validateInstructionInfo();
                }
            });

            document.getElementById('select-instruction-modal-submit-btn').addEventListener('click', (event) => {
                event.preventDefault();
                this.selectedInstructionInfo = this._getInstructionInfo();

                const modalInstance = M.Modal.getInstance(document.getElementById('instruction-select-modal'));
                modalInstance.close();

                const instructionSpan = document.getElementById('selected-instruction-span');
                instructionSpan.textContent = `${this.selectedInstructionInfo.instrument} with ${this.selectedInstructionInfo.instructorId} on ${this.selectedInstructionInfo.day} at ${this.selectedInstructionInfo.startTime} for ${this.selectedInstructionInfo.length} minutes`;

                const instructionSpanContainer = document.getElementById('selected-instruction-span-container');
                instructionSpanContainer.hidden = false;

                // validate page
                this._validateRegistration();
            });

            document.getElementById('create-registration-submit').addEventListener('click', (event) => {
                // get all data
                event.preventDefault();
                const data = {
                    studentId: this.selectedStudentId,
                    ...this.selectedInstructionInfo,
                    transportationType: document.querySelector('input[name="transportation-type"]:checked').value
                };
                debugger
                // post
                ApiClient.post(ServerFunctions.createRegistration, data, x => new Registration(x))
                    .then(response => {
                        // handle response
                        console.log('Registration created:', response);
                        M.toast({ html: 'Registration created successfully.' });

                        // reset form
                        this.selectedStudentId = null;
                        this.selectedInstructionInfo = null;

                        const studentNameSpanContainer = document.getElementById('selected-student-name-span-container');
                        studentNameSpanContainer.hidden = true;

                        const instructionSpanContainer = document.getElementById('selected-instruction-span-container');
                        instructionSpanContainer.hidden = true;

                        // clear current registrations
                        this._clearCurrentRegistrations();
                        this._setRegistrations(this.registrations);
                    })
                    .catch(error => {
                        console.error('Error creating registration:', error);
                        M.toast({ html: 'Error creating registration.' });
                    });
            });
        };

        _validateInstructionInfo() {
            const instructionInfo = this._getInstructionInfo();

            // additional validation for start time/length is valid
            // TODO

            // enable submit button if all fields are valid
            const submitButton = document.getElementById('select-instruction-modal-submit-btn');
            submitButton.classList.toggle('disabled',
                !(instructionInfo.instructorId
                    && instructionInfo.instrument
                    && instructionInfo.day
                    && instructionInfo.startTime
                    && instructionInfo.length
                ));
        }

        _validateRegistration() {
            // get transportation type response
            const transportationType = document.querySelector('input[name="transportation-type"]:checked');
            
            // enable submit button if all fields are valid
            const submitButton = document.getElementById('create-registration-submit');
            submitButton.classList.toggle('disabled',
                !(this.selectedStudentId
                    && this.selectedInstructionInfo
                    && transportationType.value));
            return ;
        }
        
        _getInstructionInfo() {
            // get selected instructor
            const instructorSelect = document.getElementById('instructor-select');

            // get selected instrument
            const instrumentSelect = document.getElementById('instrument-select');

            // get selected day
            const daySelect = document.getElementById('day-select');

            // get selected start time
            const startTimeSelect = document.getElementById('start-time-select');

            // get selected length
            const lessonLengthRadios = document.querySelectorAll('input[name="lesson-length"]');
            const checkedRadio = Array.from(lessonLengthRadios).find(radio => radio.checked);

            // add to object
            return {
                instructorId: instructorSelect.value,
                instrument: instrumentSelect.value,
                day: daySelect.value.split('_')[1], // get the day index
                startTime: startTimeSelect.value,
                length: checkedRadio ? checkedRadio.value : null
            };
        }

        _setInstructorOptions(instructors) {
            if (!instructors || instructors.length === 0) {
                this._updateSelectOptions(
                    'instructor-select',
                    [],
                    'No instructors available');
                return;
            }
            this._updateSelectOptions(
                'instructor-select',
                instructors.map(instructor => ({
                    value: instructor.id,
                    label: `${instructor.lastName}, ${instructor.firstName}`
                })),
                'Select an instructor');
        }

        _setRegistrations(registrations) {
            const currentRegistrations = document.getElementById('current-registrations');
            const currentRegistrationsCollection = document.getElementById('current-registrations-collection');

            if (!registrations || registrations.length === 0) {
                // clear collection
                this._clearCurrentRegistrations();

                // add no registrations message
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.innerHTML = '<div>No current registrations.</div>';
                currentRegistrationsCollection.appendChild(li);

                currentRegistrations.hidden = false;
                return;
            }
            
            // clear all children in 'current-registrations-collection'
            this._clearCurrentRegistrations();
            // for each registration
            registrations.forEach(registration => {
                const li = document.createElement('a');
                li.className = 'collection-item';
                li.innerHTML = `
                    <div>
                        ${registration.day}: ${registration.startTime} - ${registration.endTime}, 
                        ${registration.instrument} (${registration.lessonType}) with 
                        ${registration.instructorLastName}, ${registration.instructorFirstName}
                        <a href="#!" class="secondary-content">
                            <i class="delete-registration-icon material-icons red-text text-darken-4">delete_forever</i>
                        </a>
                    </div>`;
                currentRegistrationsCollection.appendChild(li);
            });
            
            currentRegistrations.hidden = false;
        }

        _clearCurrentRegistrations() {
            // clear collection
            const currentRegistrationsCollection = document.getElementById('current-registrations-collection');
            while (currentRegistrationsCollection.firstChild) {
                currentRegistrationsCollection.removeChild(currentRegistrationsCollection.firstChild);
            }
        }

        _setInstructorInstrumentOptions(instructor) {
            if (!instructor) {
                this._updateSelectOptions(
                    'instrument-select',
                    [],
                    'Select an instrument');
                return;
            }

            const instruments = [
                instructor.instrument1,
                instructor.instrument2,
                instructor.instrument3,
                instructor.instrument4
            ]
                .filter(x => x);

            this._updateSelectOptions(
                'instrument-select',
                instruments.map(instrument => ({
                    value: instrument,
                    label: instrument
                })),
                'Select an instrument');
        }

        _setInstructorDayOptions(instructor) {
            if (!instructor) {
                this._updateSelectOptions(
                    'day-select',
                    [],
                    'Select a day');
                return;
            }

            const weekDays = {
                0: { label: 'Monday', startTime: instructor.mondayStartTime },
                1: { label: 'Tuesday', startTime: instructor.tuesdayStartTime },
                2: { label: 'Wednesday', startTime: instructor.wednesdayStartTime },
                3: { label: 'Thursday', startTime: instructor.thursdayStartTime },
                4: { label: 'Friday', startTime: instructor.fridayStartTime }
            };

            let days = [];
            for (const [index, day] of Object.entries(weekDays)) {
                if (day.startTime) {
                    days.push({
                        value: `${instructor.id}_${index}`,
                        label: day.label
                    });
                }
            }

            this._updateSelectOptions(
                'day-select',
                days,
                'Select a day');

            const daySelectedInfoContainer = document.getElementById('instructor-day-selected-info-container');
            daySelectedInfoContainer.hidden = false;
        }

        _setInstructorDayStartTimeOptions(instructor, day) {
            if (!instructor || !day) {
                this._updateSelectOptions(
                    'start-time-select',
                    [],
                    'Select a start time');
                // default to first radio
                const lessonLengthRadios = document.querySelectorAll('input[name="lesson-length"]');
                if (lessonLengthRadios.length > 0) {
                    lessonLengthRadios[0].checked = true;
                }
                return;
            }

            const startTimes = [
                instructor.mondayStartTime,
                instructor.tuesdayStartTime,
                instructor.wednesdayStartTime,
                instructor.thursdayStartTime,
                instructor.fridayStartTime
            ];

            const endTimes = [
                instructor.mondayEndTime,
                instructor.tuesdayEndTime,
                instructor.wednesdayEndTime,
                instructor.thursdayEndTime,
                instructor.fridayEndTime
            ];

            const startTime = startTimes[day * 1];
            const startHour = parseInt(startTime.split(':')[0], 10);
            const startMinute = parseInt(startTime.split(':')[1], 10);
            const options = [];

            const endTime = endTimes[day * 1];
            const endHour = parseInt(endTime.split(':')[0], 10);
            const endMinute = parseInt(endTime.split(':')[1], 10);

            for (let i = 0; i <= (endHour * 60 + endMinute); i += 15) {
                const hour = Math.floor(i / 60) % 24;
                const minute = i % 60;
                const formattedTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                options.push(formattedTime);
            }

            this._updateSelectOptions(
                'start-time-select',
                options.map(time => ({
                    value: time,
                    label: time
                })),
                'Select a start time');
        }

        _setStudentOptions(students) {
            this._updateSelectOptions(
                'student-select',
                students.map(student => ({
                    value: student.id,
                    label: `${student.lastName}, ${student.firstName}`
                })),
                'Select a student');

            document.getElementById('student-select');
            document.getElementById('student-search').value = '';
            M.updateTextFields();
        }

        // setStudents(students) {
        //     this.updateTableAndMessage(
        //         'students-tbody',
        //         'students-empty-message',
        //         studentsData,
        //         (student) => {
        //             const tr = document.createElement('tr');
        //             tr.innerHTML = `
        //                 <td>${student.fullName}</td>
        //                 <td>${student.studentId}</td>
        //                 <td>${student.grade}</td>
        //             `;
        //             return tr;
        //         }
        //     );
        // }

        // setClasses(classes, instructors) {
        //     this.updateTableAndMessage(
        //         'classes-tbody',
        //         'classes-empty-message',
        //         classes,
        //         (classItem) => [classItem.title, instructors.find(x => x.id === classItem.instructorId).fullName, classItem.day]
        //     );
        // }

        // setRegistrations(registrations, students, instructors, rooms) {
        //     this.updateTableAndMessage(
        //         'registrations-tbody',
        //         'registrations-empty-message',
        //         registrations,
        //         (registration) => {
        //             const student = students.find(x => x.id === registration.studentId);
        //             const instructor = instructors.find(x => x.id === registration.instructorId);
        //             const room = rooms.find(x => x.id === registration.roomId);

        //             return [
        //                 student.fullName,
        //                 instructor.fullName,
        //                 room.formattedName,
        //                 registration.instrument
        //             ];
        //         }
        //     );
        // }

        // setRooms(rooms) {
        //     this.updateTableAndMessage(
        //         'rooms-tbody',
        //         'rooms-empty-message',
        //         rooms,
        //         (room) => [room.formattedName]
        //     );
        // }

        getCurrentTab() {
            const activeTab = document.querySelector('.tabs .tab a.active');
            return activeTab ? activeTab.getAttribute('id') : null;
        }

        _updateSelectOptions(selectId, options, defaultOptionText, selectClasses = '') {
            const select = document.getElementById(selectId);

            if (!select) {
                console.error(`Select element with ID "${selectId}" not found.`);
                return;
            }

            // Clear existing options
            select.innerHTML = '';

            // Create a default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultOptionText;
            select.appendChild(defaultOption);

            // Populate new options
            options.forEach((option) => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                select.appendChild(opt);
            });

            M.FormSelect.init(select, {
                classes: `${selectId} ${selectClasses}`,
                dropdownOptions: {
                    alignment: 'left',
                    coverTrigger: false,
                    constrainWidth: false
                }
            });
        }
    }
</script>