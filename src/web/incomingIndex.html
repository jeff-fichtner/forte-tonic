<!DOCTYPE html>
<html>

<head>
  <?!= include('web/css/libraries'); ?>
  <?!= include('web/js/libraries'); ?>
  <?!= include('web/js/modelRegistration'); ?>
  <style>
    li.delete-lesson-icon,
    li.add-lesson-icon {
      cursor: pointer;
    }
  </style>
  <script>
    const ServerFunctions = {
      getAuthenticatedUser: 'getAuthenticatedUser',
      getInstructors: 'getInstructors',
      getStudents: 'getStudents',
      getClasses: 'getClasses',
      getRegistrations: 'getRegistrations'
    };

    const fetch = (serverFunctionName, mapper = null, context = null, paginationOptions = {}, ...args) => {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((response) => {
            if (!response) {
              reject(new Error('Successful but empty response'));
              return;
            }

            try {
              const parsedResponse = JSON.parse(response);
              resolve(mapper ? mapper(parsedResponse) : parsedResponse);

            } catch (e) {
              reject(new Error(`Error - ${e}: ${response}`));
            }
          })
          .withFailureHandler((error) => reject(error))
          .withUserObject(context)[serverFunctionName](
            ...(paginationOptions ? [paginationOptions, ...args] : args)
          );
      });
    };

    const fetchAllPages = async (serverFunctionName, mapper, context = null, pageSize = 10, ...args) => {
      let allResults = [];
      let currentPage = 0;
      let totalPages = null;
      while (!totalPages || currentPage < totalPages) {
        try {
          const paginationOptions = { page: currentPage, pageSize };
          const response = await fetch(serverFunctionName, null, context, paginationOptions, ...args);
          if (!response) {
            break;
          }

          // set total
          if (!totalPages && response.total !== undefined) {
            totalPages = Math.ceil(response.total / pageSize);
          }

          // if total pages is not defined, throw an error
          if (!totalPages) {
            throw new Error('Total pages not defined');
          }

          const parsedResults = response.data.map(y => mapper(y));
          if (!parsedResults || parsedResults.length == 0) {
            break;
          }

          allResults = allResults.concat(parsedResults);
          currentPage++;

        } catch (error) {
          console.error(`Error fetching page ${currentPage}:`, error);
          return [];
        }
      }
      return allResults;
    };

    const promisify = (fn) => (...args) =>
      new Promise((resolve, reject) => {
        try {
          fn(...args);
          resolve(true);
        } catch (error) {
          reject(error);
        }
      });

    const promisifyWithResult = (fn) => (...args) =>
      new Promise((resolve, reject) => {
        try {
          const result = fn(...args);
          resolve(result);
        } catch (error) {
          reject(error);
        }
      });

    (async () => {
      const display = new Display();

      try {

        const [
          initializeDisplay_,
          authenticatedUser,
          allInstructors,
          // allStudents,
          allClasses,
          allRegistrations
        ] =
          await Promise.all([
            promisify(display.initialize)(),
            fetch(ServerFunctions.getAuthenticatedUser, x => new AuthenticatedUserResponse(x)),
            fetchAllPages(ServerFunctions.getInstructors, x => new Instructor(x)),
            // fetchAllPages(ServerFunctions.getStudents),
            // fetchAllPages(ServerFunctions.getClasses, x => new Class(x)),
            // fetchAllPages(ServerFunctions.getRegistrations, x => new Registration(x))
          ]);

        display.setInstructors(allInstructors);
        // display.setStudents(allStudents);
        display.setClasses(allClasses);
        // display.setRegistrations(allRegistrations);
        display.setLoading(false);

      } catch (error) {
        console.error(error);
        display.showErrorMessage('An error occurred while loading data.');
      }
    })();
  </script>
</head>

<body>
  <div class="container">
    <h1>Tonic</h1>

    <div class="valign-wrapper">
      <div id="loading" class="preloader-wrapper big active center-align">
        <div class="spinner-layer spinner-blue">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div>
          <div class="gap-patch">
            <div class="circle"></div>
          </div>
          <div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>

        <div class="spinner-layer spinner-red">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div>
          <div class="gap-patch">
            <div class="circle"></div>
          </div>
          <div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>

        <div class="spinner-layer spinner-yellow">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div>
          <div class="gap-patch">
            <div class="circle"></div>
          </div>
          <div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>

        <div class="spinner-layer spinner-green">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div>
          <div class="gap-patch">
            <div class="circle"></div>
          </div>
          <div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
      </div>
    </div>

    <div hidden id="tables" class="center-align">
      <ul class="tabs">
        <li class="tab"><a href="#instructors-tab">Instructors</a></li>
        <li class="tab"><a href="#students-tab">Students</a></li>
        <li class="tab"><a href="#classes-tab">Classes</a></li>
        <li class="tab"><a href="#registrations-tab">Registrations</a></li>
      </ul>
      <div id="instructors-tab" class="tab-content">
        <h2>Instructors</h2>
        <table hidden>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Instruments</th>
            </tr>
          </thead>
          <tbody id="instructors-tbody"></tbody>
        </table>
        <p id="instructors-empty-message" hidden>No instructors.</p>
      </div>
      <div id="students-tab" class="tab-content">
        <h2>Students</h2>
        <table hidden>
          <thead>
            <tr>
              <th>Name</th>
              <th>Student ID</th>
              <th>Grade</th>
            </tr>
          </thead>
          <tbody id="students-tbody"></tbody>
        </table>
        <p id="students-empty-message" hidden>No students.</p>
      </div>
      <div id="classes-tab" class="tab-content">
        <h2>Classes</h2>
        <table hidden>
          <thead>
            <tr>
              <th>Name</th>
              <th>Instructor</th>
              <th>Day</th>
            </tr>
          </thead>
          <tbody id="classes-tbody"></tbody>
        </table>
        <p id="classes-empty-message" hidden>No classes.</p>
      </div>
      <div id="registrations-tab" class="tab-content">
        <h2>Registrations</h2>
        <table hidden>
          <thead>
            <tr>
              <th>Student</th>
              <th>Teacher</th>
              <th>Instrument</th>
            </tr>
          </thead>
          <tbody id="registrations-tbody"></tbody>
        </table>
        <p id="registrations-empty-message" hidden>No registrations.</p>
      </div>
    </div>
    <div id="error-message" hidden>An error occurred.</div>
  </div>
</body>

</html>